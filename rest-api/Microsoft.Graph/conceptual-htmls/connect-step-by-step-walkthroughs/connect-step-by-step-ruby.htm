<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">

<body>

    <div id="holder">

<!-- HTML Page Content Start -->
<div class="container wrapper" id="body">
    <div class="row">
        <div class="col-md-9">
            <h1 id="call-the-unified-api-preview-in-a-ruby-app">Call the unified API (preview) in a Ruby app</h1>
<p>In this article we look at the minimum tasks required to get an access token from Azure Active Directory (AD) and call the unified API. We use code from the <a href="https://github.com/OfficeDev/O365-Ruby-Unified-API-Connect" target="_blank">Office 365 Ruby Connect sample using unified API</a> to explain the main concepts that you have to implement in your app.</p>
<p><img src="./images/web-screenshot.png" alt="Office 365 Ruby Connect sample screenshot" /></p>
<h2 id="overview">Overview</h2>
<p>To call the unified API (preview), your Ruby app must complete the following tasks.</p>
<ol>
<li><a href="#register">Register the application in Azure Active Directory</a></li>
<li><a href="#redirect">Redirect the browser to the sign-in page</a></li>
<li><a href="#authcode">Receive an authorization code in your reply URL page</a></li>
<li><a href="#accesstoken">Request an access token from the token endpoint</a></li>
<li><a href="#request">Use the access token in a request to the unified API</a> </li>
</ol>
<p>&lt;a name=&quot;register&quot;/&gt;</p>
<h2 id="register-the-application-in-azure-active-directory">Register the application in Azure Active Directory</h2>
<p>Before you can start working with Office 365, you need to register your application on Azure AD and set permissions to use unified API services.</p>
<p>See <a href="https://msdn.microsoft.com/office/office365/HowTo/add-common-consent-manually#bk_RegisterServerApp" target="_blank">Register your web server app with the Azure Management Portal</a> for instructions, keep in mind the following details.</p>
<ul>
<li>Specify a route in your Ruby app as the <strong>Sign-on URL</strong> in step 6. In the case of the Connect sample, this is <a href="https://github.com/OfficeDev/O365-Ruby-Unified-API-Connect/blob/master/app/controllers/pages_controller.rb#L38" target="_blank"><code>/auth/azureactivedirectory/callback</code></a>.</li>
<li><a href="https://github.com/OfficeDev/O365-Ruby-Unified-API-Connect/wiki/Grant-permissions-to-the-Connect-application-in-Azure" target="_blank">Configure the <strong>Delegated permissions</strong></a> that your app requires. The Connect sample requires <strong>Send mail as signed-in user</strong> permission.</li>
</ul>
<p>Take note of the following values in the <strong>Configure</strong> page of your Azure application.</p>
<ul>
<li>Client ID</li>
<li>A valid key</li>
<li>A reply URL</li>
</ul>
<p>You need these values as parameters in the OAuth flow in your app.</p>
<p>&lt;a name=&quot;redirect&quot;/&gt;</p>
<h2 id="redirect-the-browser-to-the-sign-in-page">Redirect the browser to the sign-in page</h2>
<p>Your app needs to redirect the browser to the sign-in page to get an authorization code and continue the OAuth flow.</p>
<p>In the Connect sample, redirection is handled by the OmniAuth library. Our app just delegates execution to the <a href="https://github.com/OfficeDev/O365-Ruby-Unified-API-Connect/blob/master/app/controllers/pages_controller.rb#L30" target="_blank"><code>/auth/azureactivedirectory</code></a> route managed by OmniAuth.</p>
<p>&lt;a name=&quot;authcode&quot;/&gt;</p>
<h2 id="receive-an-authorization-code-in-your-reply-url-page">Receive an authorization code in your reply URL page</h2>
<p>After the user signs-in, the flow returns the browser to the reply URL in your app. Azure appends an authorization code to the query string. The Connect sample uses the <a href="https://github.com/OfficeDev/O365-Ruby-Unified-API-Connect/blob/master/app/controllers/pages_controller.rb#L38" target="_blank"><code>/auth/azureactivedirectory/callback</code></a> route for this purpose.</p>
<p>The authorization code is provided in the <code>code</code> query string variable. The Connect sample saves the code to a local variable to use it later.</p>
<pre><code class="ruby">code = params[:code]
</code></pre>

<p>&lt;a name=&quot;accesstoken&quot;/&gt;</p>
<h2 id="request-an-access-token-from-the-token-endpoint">Request an access token from the token endpoint</h2>
<p>Once you have the authorization code, you can use it along the client ID, key, and reply URL values that you got from Azure AD to request an access token. </p>
<blockquote>
<p><strong>Note:</strong> &lt;br /&gt;
The request must also specify a resource that we are trying to consume. In the case of unified API, the resource value is <code>https://graph.microsoft.com</code>.</p>
</blockquote>
<p>Again, the Connect sample delegates this task to the OmniAuth library. The <a href="https://github.com/OfficeDev/O365-Ruby-Unified-API-Connect/blob/master/app/controllers/pages_controller.rb#L62" target="_blank"><code>acquire_access_token</code></a> function calls the library and passes the authentication code saved in the previous section along with the reply URL, client ID, client secret and resource ID.</p>
<pre><code class="ruby">def acquire_access_token(auth_code, reply_url)
    AUTH_CTX.acquire_token_with_authorization_code(
                  auth_code,
                  reply_url,
                  CLIENT_CRED,
                  GRAPH_RESOURCE)
end
</code></pre>

<blockquote>
<p><strong>Note:</strong> &lt;br /&gt;
The client ID and client secret are provided in the <code>CLIENT_CRED</code> parameter in the previous code snippet.</p>
</blockquote>
<p>&lt;a name=&quot;request&quot;/&gt;</p>
<h2 id="use-the-access-token-in-a-request-to-the-unified-api-preview">Use the access token in a request to the unified API (preview)</h2>
<p>With an access token, your app can make authenticated requests to the unified API. Your app must provide the access token in the <strong>Authorization</strong> header of each request.</p>
<p>The Connect sample sends an email using the <strong>sendMail</strong> endpoint in the unified API. The code is in the <a href="https://github.com/OfficeDev/O365-Ruby-Unified-API-Connect/blob/master/app/controllers/pages_controller.rb#L82" target="_blank"><code>send_mail</code></a> function. This is the code that shows how to send the access code in the Authorization header.</p>
<pre><code class="ruby">def send_mail
  # Used in the template
  @name = session[:name]
  @email = params[:specified_email]
  @recipient = params[:specified_email]
  @mailSent = false
  
  sendMailEndpoint = URI(&quot;#{GRAPH_RESOURCE}#{SENDMAIL_ENDPOINT}&quot;)
  http = Net::HTTP.new(sendMailEndpoint.host, sendMailEndpoint.port)
  http.use_ssl = true
  
  emailBody = File.read(&quot;app/assets/MailTemplate.html&quot;)
  emailBody.sub! &quot;{given_name}&quot;, @name
  
  emailMessage = &quot;{
          Message: {
          Subject: 'Welcome to Office 365 development with Ruby',
          Body: {
              ContentType: 'HTML',
              Content: '#{emailBody}'
          },
          ToRecipients: [
              {
                  EmailAddress: {
                      Address: '#{@recipient}'
                  }
              }
          ]
          },
          SaveToSentItems: true
          }&quot;

  response = http.post(
    SENDMAIL_ENDPOINT, 
    emailMessage, 
    initheader = 
    {
      &quot;Authorization&quot; =&gt; &quot;Bearer #{session[:access_token]}&quot;, 
      &quot;Content-Type&quot; =&gt; CONTENT_TYPE
    }
  )

  # The send mail endpoint returns a 202 - Accepted code on success
  if response.code == &quot;202&quot;
    @mailSent = true
  else
    @mailSent = false
    flash[:httpError] = &quot;#{response.code} - #{response.message}&quot;
  end
  
  render &quot;callback&quot;
end
</code></pre>

<blockquote>
<p><strong>Note:</strong> &lt;br /&gt;
The request must also send a <strong>Content-Type</strong> header with a value accepted by the unified API, for example, <code>application/json;odata.metadata=minimal;odata.streaming=true</code>.</p>
</blockquote>
<p>The unified API (preview) is a very powerful, unifiying API that can be used to interact with all kinds of Microsoft data. Check out the <a href="https://msdn.microsoft.com/office/office365/howto/office-365-unified-api-reference" target="_blank">API reference</a> to explore what else you can accomplish with the unified API.</p>
<h2 id="additional-resources">Additional resources</h2>
<ul>
<li><a href="https://github.com/OfficeDev/O365-Ruby-Unified-API-Connect" target="_blank">Office 365 Ruby Connect sample using unified API</a></li>
<li><a href="http://dev.office.com" target="_blank">Office Dev Center</a> </li>
<li><a href="https://msdn.microsoft.com/office/office365/howto/office-365-unified-api-reference" target="_blank">Unified API (preview) reference</a></li>
</ul>

        </div>
        <div id="tocbar" class="col-md-3 visible-md visible-lg">
            <p><a href="../README.htm">API Reference</a></p>
        <ul>
            
        </ul>
        </div>
    </div>
</div>
<!-- HTML Page Content End -->

</div>

</body>




