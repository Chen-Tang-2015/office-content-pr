<div id="holder">

<!-- HTML Page Content Start -->

<div class="container wrapper" id="body">
    <div class="row">
        <div class="col-md-9">
            <h1 id="call-the-microsoft-graph-api-in-a-python-app">Call the Microsoft Graph API in a Python app</h1>
<p>In this article we look at the minimum tasks required to connect your application to Office 365 and call the Microsoft Graph API. We use code from the <a href="https://github.com/OfficeDev/O365-Python-Unified-API-Connect" target="_blank">Office 365 Python Connect sample using Microsoft Graph</a> to explain the main concepts that you have to implement in your app.</p>
<p><img src="./images/web-screenshot.png" alt="Office 365 Python Connect sample screenshot" /></p>
<h2 id="prerequisites">Prerequisites</h2>
<p>This topic assumes the following:</p>
<ul>
<li>You are comfortable reading Python code.</li>
<li>You are familiar with OAuth concepts.</li>
</ul>
<h2 id="overview">Overview</h2>
<p>To call the Microsoft Graph API, your Python app must complete the following tasks.</p>
<ol>
<li><a href="#register">Register the application in Azure Active Directory</a></li>
<li><a href="#redirect">Redirect the browser to the sign in page</a></li>
<li><a href="#authCode">Receive an authorization code in your reply URL page</a></li>
<li><a href="#accessToken">Request an access token from the token issuing endpoint</a></li>
<li><a href="#request">Use the access token in a request to the Microsoft Graph API</a> </li>
</ol>
<p>&lt;a name=&quot;register&quot;&gt;</a></p>
<h2 id="register-the-application-in-azure-active-directory">Register the application in Azure Active Directory</h2>
<p>Before you can start working with Office 365, you need to register your application in Azure Active Directory and set permissions to use Microsoft Graph services.</p>
<p>See <a href="https://msdn.microsoft.com/office/office365/HowTo/add-common-consent-manually#bk_RegisterServerApp" target="_blank">Register your web server app with the Azure Management Portal</a> for instructions, and keep in mind the following details.</p>
<ul>
<li>Make sure to specify http://127.0.0.1:8000/connect/get_token/ as the <strong>Sign-on URL</strong>.</li>
<li>After you register the application, <a href="https://github.com/OfficeDev/O365-Python-Unified-API-Connect/wiki/Grant-permissions-to-the-Connect-application-in-Azure" target="_blank">configure the <strong>Delegated permissions</strong></a> that your Python app requires. The Connect sample requires the <strong>Send mail as signed-in user</strong> permission.</li>
</ul>
<p>Take note of the following values in the <strong>Configure</strong> page of your Azure application because you need these values to configure the OAuth flow in your Python app.</p>
<ul>
<li>Client ID (unique to your application)</li>
<li>A reply URL (http://127.0.0.1:8000/connect/get_token/)</li>
<li>An application key (unique to your application)</li>
</ul>
<p>&lt;a name=&quot;redirect&quot;&gt;</a></p>
<h2 id="redirect-the-browser-to-the-sign-in-page">Redirect the browser to the sign in page</h2>
<p>Your app needs to redirect the browser to the sign in page to begin the OAuth flow and get an authorization code. </p>
<p>In the Connect sample, the following code (located in <a href="https://github.com/OfficeDev/O365-Python-Unified-API-Connect/blob/master/connect/auth_helper.py" target="_blank"><em>connect/auth_helper.py</em></a>) builds the URL that the app needs to redirect the user to and is piped to the view where it can be used for redirection. </p>
<pre><code class="python"># This function creates the signin URL that the app will
# direct the user to in order to sign in to Office 365 and
# give the app consent.
def get_signin_url(redirect_uri):
  # Build the query parameters for the signin URL.
  params = { 'client_id': client_id,
             'redirect_uri': redirect_uri,
             'response_type': 'code'
           }

  authorize_url = '{0}{1}'.format(authority, '/common/oauth2/authorize?{0}')
  signin_url = authorize_url.format(urlencode(params))
  return signin_url
</code></pre>

<p>&lt;a name=&quot;authCode&quot;&gt;</a></p>
<h2 id="receive-an-authorization-code-in-your-reply-url-page">Receive an authorization code in your reply URL page</h2>
<p>After the user signs in, the browser is redirected to your reply URL, the <code>get_token</code> function in <a href="https://github.com/OfficeDev/O365-Python-Unified-API-Connect/blob/master/connect/views.py" target="_blank"><em>connect/views.py</em></a>, with an authorization code appended to the query string as the <code>code</code> variable. </p>
<p>The Connect sample gets the code from the query string so it can then exchange it for an access token.</p>
<pre><code class="python">auth_code = request.GET['code']
</code></pre>

<p>&lt;a name=&quot;accessToken&quot;&gt;</a></p>
<h2 id="request-an-access-token-from-the-token-issuing-endpoint">Request an access token from the token issuing endpoint</h2>
<p>Once you have the authorization code, you can use it along the client ID, key, and reply URL values that you got from Azure Active Directory to request an access token. </p>
<blockquote>
<p><strong>Note</strong> The request must also specify a resource that you are trying to consume. In the case of Microsoft Graph, the resource value is <code>https://graph.microsoft.com</code>.</p>
</blockquote>
<p>The Connect sample requests a token in the <code>get_token_from_code</code> function in the <a href="https://github.com/OfficeDev/O365-Python-Unified-API-Connect/blob/master/connect/auth_helper.py" target="_blank"><em>connect/auth_helper.py</em></a> file.</p>
<pre><code class="python"># This function passes the authorization code to the token
# issuing endpoint, gets the token, and then returns it.
def get_token_from_code(auth_code, redirect_uri):
  # Build the post form for the token request
  post_data = { 'grant_type': 'authorization_code',
                'code': auth_code,
                'redirect_uri': redirect_uri,
                'client_id': client_id,
                'client_secret': client_secret,
                'resource': 'https://graph.microsoft.com'
              }
              
  r = requests.post(token_url, data = post_data)
  
  try:
    return r.json()
  except:
    return 'Error retrieving token: {0} - {1}'.format(r.status_code, r.text)
</code></pre>

<blockquote>
<p><strong>Note</strong> The response provides more information than just the access token. For example, your app can get a refresh token to request new access tokens without having the user explicitly sign in again.</p>
</blockquote>
<p>&lt;a name=&quot;request&quot;&gt;</a></p>
<h2 id="use-the-access-token-in-a-request-to-the-microsoft-graph-api">Use the access token in a request to the Microsoft Graph API</h2>
<p>With an access token, your app can make authenticated requests to the Microsoft Graph API. Your app must append the access code to the <strong>Authorization</strong> header of each request.</p>
<p>The Connect sample sends an email using the <code>me/sendMail</code> endpoint in the Microsoft Graph API. The code is in the <code>call_sendMail_endpoint</code> function in the <a href="https://github.com/OfficeDev/O365-Python-Unified-API-Connect/blob/master/connect/graph_service.py" target="_blank"><em>connect/graph_service.py</em></a> file. This is the code that shows how to append the access code to the Authorization header.</p>
<pre><code class="python"># Set request headers.
headers = { 
  'User-Agent' : 'python_tutorial/1.0',
  'Authorization' : 'Bearer {0}'.format(access_token),
  'Accept' : 'application/json',
  'Content-Type' : 'application/json'
}
</code></pre>

<blockquote>
<p><strong>Note</strong> The request must also send a <strong>Content-Type</strong> header with a value accepted by the Graph API, for example, <code>application/json</code>.</p>
</blockquote>
<p>The Microsoft Graph is a very powerful, unifiying API that can be used to interact with all kinds of Microsoft data. Check out the <a href="">API reference</a> to explore what else you can accomplish with the Microsoft Graph API.</p>
<h2 id="additional-resources">Additional resources</h2>
<ul>
<li><a href="https://github.com/OfficeDev/O365-Python-Unified-API-Connect" target="_blank">Office 365 Python Connect sample using Microsoft Graph</a></li>
<li><a href="http://dev.office.com" target="_blank">Office Dev Center</a> </li>
<li><a href="">Microsoft Graph API reference</a></li>
</ul>

        </div>        
    </div>
</div>
<!-- HTML Page Content End -->

</div>





